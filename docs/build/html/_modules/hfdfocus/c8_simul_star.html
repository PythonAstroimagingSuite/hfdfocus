

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>hfdfocus.c8_simul_star &mdash; hfdfocus 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> hfdfocus
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../autofocus_hfd_script.html">Using autofocus_hfd_script.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autofocus_auto_star.html">Using autofocus_auto_star.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_vcurves.html">Using V Curves</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hfdfocus</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>hfdfocus.c8_simul_star</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hfdfocus.c8_simul_star</h1><div class="highlight"><pre>
<span></span><span class="c1"># simulate C8 @ f/7 star based on v curve data</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#Fit:</span>
<span class="c1">#</span>
<span class="c1">#2019-05-16 18:51:29,897 INFO     siegel left  fit = (-0.04791842143243222, 382.9895493357121)</span>
<span class="c1">#2019-05-16 18:51:29,898 INFO     siegel right fit = (0.04235856430687786, -337.733122948905)</span>
<span class="c1">#2019-05-16 18:51:29,898 INFO     siegel best pos  = 7983.459642370256</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO     Left Side:</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        slope: -0.04791842143243222</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        inter: 382.9895493357121</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        yzero: 7992.532681314426</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        PID  : -9.073038944169639</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO     Right Side:</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        slope: 0.04235856430687786</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        inter: -337.733122948905</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        yzero: 7973.195703756808</span>
<span class="c1">#2019-05-16 18:51:29,901 INFO        PID  : 10.263938613447863</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">pyfits</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import skimage.transform as tf</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndimage</span>
<span class="kn">from</span> <span class="nn">hfdfocus.StarFitHFD</span> <span class="k">import</span> <span class="n">find_brightest_star_HFD</span>


<div class="viewcode-block" id="shrink_star"><a class="viewcode-back" href="../../hfdfocus.html#hfdfocus.c8_simul_star.shrink_star">[docs]</a><span class="k">def</span> <span class="nf">shrink_star</span><span class="p">(</span><span class="n">starimage_data</span><span class="p">,</span> <span class="n">bgimage_data</span><span class="p">,</span> <span class="n">reduction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a 2D image shrink by the reduction factor and pad the outer areas</span>
<span class="sd">    with the median of the image data.</span>

<span class="sd">    :param starimage_data: 2D numpy image data to be reduced.</span>
<span class="sd">    :param bgimage_data: 2D numpy image data for a background region to be sampled.</span>
<span class="sd">    :param reduction: Scaling factor (0-1).</span>
<span class="sd">    :return: Scaled down image:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ht</span><span class="p">,</span> <span class="n">wd</span> <span class="o">=</span> <span class="n">starimage_data</span><span class="o">.</span><span class="n">shape</span>
<span class="c1">#    shrunk_star_data = tf.resize(starimage_data,</span>
<span class="c1">#                                    [int(ht*reduction), int(wd*reduction)],</span>
<span class="c1">#                                    order=0, mode=&#39;constant&#39;, anti_aliasing=True)</span>
    <span class="n">shrunk_star_data</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">starimage_data</span><span class="p">,</span>
                                    <span class="p">[</span><span class="n">reduction</span><span class="p">,</span> <span class="n">reduction</span><span class="p">],</span>
                                    <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span><span class="c1">#, anti_aliasing=True)</span>
    <span class="c1"># scale it up so flux is the same</span>
    <span class="n">bgmed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bgimage_data</span><span class="p">)</span>
    <span class="n">shrunk_star_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">shrunk_star_data</span><span class="o">-</span><span class="n">bgmed</span><span class="p">)</span><span class="o">/</span><span class="n">reduction</span><span class="o">/</span><span class="n">reduction</span> <span class="o">+</span> <span class="n">bgmed</span>
    <span class="n">sh_ht</span><span class="p">,</span> <span class="n">sh_wd</span> <span class="o">=</span> <span class="n">shrunk_star_data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># composite shrunk data centered on bg data</span>
    <span class="n">bg_ht</span><span class="p">,</span> <span class="n">bg_wd</span> <span class="o">=</span> <span class="n">bgimage_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">lx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bg_wd</span><span class="o">-</span><span class="n">sh_wd</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">hx</span> <span class="o">=</span> <span class="n">lx</span> <span class="o">+</span> <span class="n">sh_wd</span>
    <span class="n">ly</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bg_ht</span><span class="o">-</span><span class="n">sh_ht</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">hy</span> <span class="o">=</span> <span class="n">ly</span> <span class="o">+</span> <span class="n">sh_ht</span>
    <span class="c1">#print(bg_ht, bg_wd, sh_ht, sh_wd)</span>
    <span class="c1">#print(lx,hx,ly,hy)</span>
    <span class="n">shrunk_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bgimage_data</span><span class="p">)</span>
    <span class="n">shrunk_image</span><span class="p">[</span><span class="n">ly</span><span class="p">:</span><span class="n">hy</span><span class="p">,</span> <span class="n">lx</span><span class="p">:</span><span class="n">hx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">shrunk_image</span><span class="p">[</span><span class="n">ly</span><span class="p">:</span><span class="n">hy</span><span class="p">,</span> <span class="n">lx</span><span class="p">:</span><span class="n">hx</span><span class="p">],</span> <span class="n">shrunk_star_data</span><span class="p">)</span>
    <span class="c1">#pyfits.writeto(f&#39;shrunk_data.fits&#39;, shrunk_data.astype(float), overwrite=True)</span>

    <span class="k">return</span> <span class="n">shrunk_image</span></div>


<div class="viewcode-block" id="C8_F7_Star_Simulator"><a class="viewcode-back" href="../../hfdfocus.html#hfdfocus.c8_simul_star.C8_F7_Star_Simulator">[docs]</a><span class="k">class</span> <span class="nc">C8_F7_Star_Simulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates the defocused star from a Celestron C8 8 inch f/10 SCT reduced</span>
<span class="sd">    to f/7.  Uses actual image data and scales down the image depending on the</span>
<span class="sd">    focus position requested.</span>

<span class="sd">    :param starimage_name: Name of FITS image data for defocused star.</span>
<span class="sd">    :param bgimage_name: Name of FITS image containing background only.</span>
<span class="sd">    :param companion_offset: Optional offset (x, y) in pixels for another simulated star.</span>
<span class="sd">    :param companion_ratio: Ratio (0-1) of brightness of companion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">starimage_name</span><span class="o">=</span><span class="s1">&#39;../data/C8_Simul_Defocus_Star.fit&#39;</span><span class="p">,</span>
                 <span class="n">bgimage_name</span><span class="o">=</span><span class="s1">&#39;../data/C8_Simul_BG.fit&#39;</span><span class="p">,</span>
                 <span class="n">companion_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">companion_flux_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>

        <span class="c1"># load background image</span>
        <span class="c1">#bgimage_name = &#39;data/C8_Simul_BG.fit&#39;</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">bgimage_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bgimage_data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># load star image</span>
        <span class="c1">#starimage_name = &#39;data/C8_Simul_Defocus_Star.fit&#39;</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">starimage_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starimage_data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># will compute when required so we don&#39;t</span>
        <span class="c1"># create logging and other computations on creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_hfd</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># simulate a nearby star</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companion_offset</span> <span class="o">=</span> <span class="n">companion_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companion_flux_ratio</span> <span class="o">=</span> <span class="n">companion_flux_ratio</span>

    <span class="c1"># measured best focus position from sampled V curve</span>
<div class="viewcode-block" id="C8_F7_Star_Simulator.get_best_focus_pos"><a class="viewcode-back" href="../../hfdfocus.html#hfdfocus.c8_simul_star.C8_F7_Star_Simulator.get_best_focus_pos">[docs]</a>    <span class="k">def</span> <span class="nf">get_best_focus_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the focus position for simulated model of smallest star size.</span>

<span class="sd">        :returns: Focus position of smallest star size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">7983</span></div>

    <span class="c1"># based on data measured 2019/05/13 on C8 @ f/7</span>
<div class="viewcode-block" id="C8_F7_Star_Simulator.simul_hfd_size"><a class="viewcode-back" href="../../hfdfocus.html#hfdfocus.c8_simul_star.C8_F7_Star_Simulator.simul_hfd_size">[docs]</a>    <span class="k">def</span> <span class="nf">simul_hfd_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_pos</span><span class="p">,</span> <span class="n">focus_cen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute HFD size at focus position based on a model.</span>

<span class="sd">        :param focus_pos: Focus position for computation.</span>
<span class="sd">        :param focus_cen: Focus position of best focus.</span>
<span class="sd">        :return: HFD at requested focus position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load this on demand</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_hfd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># measure star size</span>
            <span class="n">scen</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">hfl</span><span class="p">,</span> <span class="n">hfr</span><span class="p">,</span> <span class="n">totflux</span><span class="p">,</span> <span class="n">alone</span> <span class="o">=</span> <span class="n">find_brightest_star_HFD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starimage_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_hfd</span> <span class="o">=</span> <span class="n">hfr</span><span class="o">-</span><span class="n">hfl</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Reference star HFD = </span><span class="si">{self.ref_hfd}</span><span class="s1">&#39;</span><span class="p">)</span>


        <span class="c1"># equation is for fit to left side of vcurve</span>
        <span class="c1"># we will just mirror it to right side</span>
        <span class="c1"># df needs to be negative because of how left side fit was done</span>
        <span class="c1">#</span>
        <span class="n">df</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">focus_pos</span> <span class="o">-</span> <span class="n">focus_cen</span><span class="p">)</span>
        <span class="n">hfd</span> <span class="o">=</span> <span class="mf">2.03638808511032E-10</span><span class="o">*</span><span class="n">df</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">3.38300076148509E-07</span><span class="o">*</span><span class="n">df</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> \
              <span class="mf">0.00018332706661</span><span class="o">*</span><span class="n">df</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.011952045599155</span><span class="o">*</span><span class="n">df</span> <span class="o">+</span> <span class="mf">2.38830504454329</span>
        <span class="k">return</span> <span class="n">hfd</span></div>

    <span class="c1"># given a desired &#39;best focus&#39; position focus_cen and</span>
    <span class="c1"># a current focuser position return a scaled image of</span>
    <span class="c1"># a defocused star based on sampled V curve data</span>
<div class="viewcode-block" id="C8_F7_Star_Simulator.get_simul_star_image"><a class="viewcode-back" href="../../hfdfocus.html#hfdfocus.c8_simul_star.C8_F7_Star_Simulator.get_simul_star_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_simul_star_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_pos</span><span class="p">,</span> <span class="n">focus_cen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return simulated star image for requested focus position.</span>

<span class="sd">        :param focus_pos: Focus position for computation.</span>
<span class="sd">        :param focus_cen: Focus position of best focus.</span>
<span class="sd">        :return: 2D simulated star image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">focus_cen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">focus_cen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_focus_pos</span><span class="p">()</span>
        <span class="n">hfd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simul_hfd_size</span><span class="p">(</span><span class="n">focus_pos</span><span class="p">,</span> <span class="n">focus_cen</span><span class="p">)</span>
        <span class="n">red</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">hfd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_hfd</span><span class="p">)</span>
        <span class="n">shrunk_image</span> <span class="o">=</span> <span class="n">shrink_star</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starimage_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bgimage_data</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span>

        <span class="c1"># make another star offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">companion_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="c1">#            tform = tf.SimilarityTransform(scale=1, translation=self.companion_offset)</span>
<span class="c1">#            comp_image = tf.warp(shrunk_image, tform, mode=&#39;constant&#39;,</span>
<span class="c1">#                                 cval=np.median(shrunk_image))</span>
            <span class="c1"># flip x/y offsets</span>
            <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">companion_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">companion_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">comp_image</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">shrunk_image</span><span class="p">,</span> <span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
                                 <span class="n">cval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">shrunk_image</span><span class="p">))</span>
            <span class="n">shrunk_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">shrunk_image</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">companion_flux_ratio</span><span class="o">*</span><span class="n">comp_image</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">companion_flux_ratio</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shrunk_image</span></div></div>


<div class="viewcode-block" id="parse_commandline"><a class="viewcode-back" href="../../hfdfocus.html#hfdfocus.c8_simul_star.parse_commandline">[docs]</a><span class="k">def</span> <span class="nf">parse_commandline</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;focus_cen&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Focus position for best focus&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;focus_pos&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Current focus position&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;focus_slope&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;V curve slope&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;focus_pid&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;V curve PID&#39;</span><span class="p">)</span>

    <span class="c1">#    parser.add_argument(&#39;--debuggraphs&#39;, action=&#39;store_true&#39;, help=&quot;Display debug graphs&quot;)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;c8_simul_star.log&#39;</span><span class="p">,</span>
                        <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="c1"># add to screen as well</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_commandline</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;args = </span><span class="si">{args}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># load background image</span>
    <span class="n">bgimage_name</span> <span class="o">=</span> <span class="s1">&#39;data/C8_Simul_BG.fit&#39;</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">bgimage_name</span><span class="p">)</span>
    <span class="n">bgimage_data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># load star image</span>
    <span class="n">starimage_name</span> <span class="o">=</span> <span class="s1">&#39;data/C8_Simul_Defocus_Star.fit&#39;</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">starimage_name</span><span class="p">)</span>
    <span class="n">starimage_data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># measure star size</span>
    <span class="n">scen</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">hfl</span><span class="p">,</span> <span class="n">hfr</span> <span class="o">=</span> <span class="n">find_brightest_star_HFD</span><span class="p">(</span><span class="n">starimage_data</span><span class="p">,</span> <span class="n">debugplots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ref_hfd</span> <span class="o">=</span> <span class="n">hfr</span><span class="o">-</span><span class="n">hfl</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Reference star HFD = </span><span class="si">{ref_hfd}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">shrunk_image</span> <span class="o">=</span> <span class="n">shrink_star</span><span class="p">(</span><span class="n">starimage_data</span><span class="p">,</span> <span class="n">bgimage_data</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">scen</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">hfl</span><span class="p">,</span> <span class="n">hfr</span> <span class="o">=</span> <span class="n">find_brightest_star_HFD</span><span class="p">(</span><span class="n">shrunk_image</span><span class="p">,</span> <span class="n">debugplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debugfits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shrunk_hfd</span> <span class="o">=</span> <span class="n">hfr</span><span class="o">-</span><span class="n">hfl</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;50</span><span class="si">% s</span><span class="s1">hrunk star HFD = </span><span class="si">{shrunk_hfd}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">#    focus_cen = 7983</span>
<span class="c1">#    focus_ref = 7350</span>
<span class="c1">#    focus_slope = 0.04235856430687786</span>
<span class="c1">#    focus_pid =  10.263938613447863</span>
<span class="c1">#    f = open(&#39;c8_simul_hfd.txt&#39;, &#39;w&#39;)</span>
<span class="c1">#    for fpos in range(7350, 8500, 50):</span>
<span class="c1">#        df = fpos - focus_cen</span>
<span class="c1">#        hfd = simul_hfd_size(fpos, focus_cen)</span>
<span class="c1">#        red = min(1.0, hfd/ref_hfd)</span>
<span class="c1">#        shrunk_image = shrink_star(starimage_data, bgimage_data, red)</span>
<span class="c1">#        scen, sl, sr, hfl, hfr = find_brightest_star_HFD(shrunk_image, debugplots=True, debugfits=True)</span>
<span class="c1">#        shrunk_hfd = hfr-hfl</span>
<span class="c1">#        f.write(f&#39;{fpos}, {shrunk_hfd}\n&#39;)</span>
<span class="c1">#    f.close()</span>

    <span class="n">c8simul</span> <span class="o">=</span> <span class="n">C8_F7_Star_Simulator</span><span class="p">(</span><span class="s1">&#39;data/C8_Simul_Defocus_Star.fit&#39;</span><span class="p">,</span> <span class="s1">&#39;data/C8_Simul_BG.fit&#39;</span><span class="p">)</span>
    <span class="n">focus_cen</span> <span class="o">=</span> <span class="mi">7983</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;c8_simul_hfd_2.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fpos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7350</span><span class="p">,</span> <span class="mi">8500</span><span class="p">,</span> <span class="mi">50</span><span class="p">):</span>
        <span class="n">shrunk_image</span> <span class="o">=</span> <span class="n">c8simul</span><span class="o">.</span><span class="n">get_simul_star_image</span><span class="p">(</span><span class="n">fpos</span><span class="p">,</span> <span class="n">focus_cen</span><span class="p">)</span>
        <span class="n">scen</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">hfl</span><span class="p">,</span> <span class="n">hfr</span> <span class="o">=</span> <span class="n">find_brightest_star_HFD</span><span class="p">(</span><span class="n">shrunk_image</span><span class="p">,</span> <span class="n">debugplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debugfits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shrunk_hfd</span> <span class="o">=</span> <span class="n">hfr</span><span class="o">-</span><span class="n">hfl</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{fpos}</span><span class="s1">, </span><span class="si">{shrunk_hfd}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>




</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Michael Fulbright

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>